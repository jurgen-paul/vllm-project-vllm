ARG BASE_IMAGE="us-central1-docker.pkg.dev/tpu-pytorch-releases/docker/xla:r2.6.0_3.10_tpuvm"

FROM $BASE_IMAGE
WORKDIR /workspace/vllm

# Install some basic utilities
RUN apt-get update && apt-get install -y \
    git \
    ffmpeg libsm6 libxext6 libgl1

# Install uv for faster pip installs
RUN --mount=type=cache,target=/root/.cache/uv \
    python3 -m pip install uv

# Install Python dependencies
COPY requirements-common.txt requirements-common.txt
COPY requirements-tpu.txt requirements-tpu.txt
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system -r requirements-tpu.txt

# Build vLLM.
COPY . .
ARG GIT_REPO_CHECK=0
RUN --mount=type=bind,source=.git,target=.git \
    if [ "$GIT_REPO_CHECK" != 0 ]; then bash tools/check_repo.sh; fi

ENV VLLM_TARGET_DEVICE="tpu"
RUN python3 setup.py develop

# install development dependencies (for testing)
RUN uv pip install --system -e tests/vllm_test_utils

CMD ["/bin/bash"]
